' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'################################################
'# nom du fichier           : FacturefmA.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/09/2007
'# Facturation périodique
'################################################
'

son As Integer = Start.Son
b As Integer
Tab As String
Tab2 As String
Tab3 As String
Tab4 As String
rResult As Result
CblRslt As Result
numbl As Result
Nfac As String
Jnl As String
cpt As String
Intit As String
numecr As String
numr As Integer
numr2 As Integer ' numero ecriture définitif
cptRem As String
Ctva As String
Ctx As String
cpttva As String
IntitTva As String
Txtleg As String
Txtleg2 As String
Remmo As String
Remart As String
Mgart As String ' Montant marge article
Mgmo As String ' Montant marge mo
Ttva As Float
dateech As String
Filename As String
jour As String
Nbl As Integer
Nlgn As String
Totalmo As String
Totalart As String
Totalrem As String
totalht As String
Totht As String
typeL As String
Fam As String
Ardi As String
nbdec As String
Totttc As String
Brutht As String
Rem As String
TotEuros As String = "0"
nom As String
Mttc As String
adr211 As String
adr222 As String
numbonl As String
Bonl As Result
dtex As String
dte As String
Devises As String
PosY As Integer
Visudoc As Boolean
Coulfond As New String[]
Private sclient As String
Private sclient2 As String
Public Bsel As Boolean = False
Public Cclient As String
Private ty As String
Private Ccli As String
Private dateech2 As String
Private pdf As Cdocuments
Private hnew As File
Private mail2 As String
Private $rs_soc As String
Private $cli_nom As String
Private $cli_pnm As String
Private $cli_adr1 As String
Private $cli_adr2 As String
Private $cli_cd_ptl As String
Private $cli_ville As String
Private scode As String
Private numrd As Integer
Private bnumfac As Boolean = False
Private numeroFac As String

'**********************************************************
'*initialisation écrans et gestion onglet client          *
'**********************************************************
Public Sub _New()

  Dim $lp, $imp As String

  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & tab & "")
  If rResult.Available Then
    devises = rResult!devise
    If IsNull(devises) Then devises = "Euros"
  Endif
  Coulfond = Utils.Coulfd()
  Utils.Observers(Me)
  Music.Load(Start.Musique)

  Me.Center

  Colbl.Columns.count = 6
  Colbl.Columns[0].Width = 80
  Colbl.Columns[1].Width = 150
  Colbl.Columns[2].Width = 60
  Colbl.Columns[3].Width = 120
  Colbl.Columns[4].Width = 100
  Colbl.Columns[0].Text = "Code"
  Colbl.Columns[0].Alignment = 1
  Colbl.Columns[1].Text = "Nom"
  Colbl.Columns[1].Alignment = 1
  Colbl.Columns[2].Text = "Cp"
  Colbl.Columns[2].Alignment = 1
  Colbl.Columns[3].Text = "Ville"
  Colbl.Columns[4].Text = "Total ht"
  Colbl.Columns[4].Alignment = 2
  Colbl.Columns[5].Text = "Total ttc"
  Colbl.Columns[5].Alignment = 2

  Coldetail.Columns.count = 4
  Coldetail.Columns[0].Width = 120
  Coldetail.Columns[2].Alignment = Align.Left
  Coldetail.Columns[1].Width = 120
  Coldetail.Columns[2].Width = 120
  Coldetail.Columns[0].Text = "N° BL"
  Coldetail.Columns[1].Text = "Date BL"
  Coldetail.Columns[2].Text = "montant HT"
  Coldetail.Columns[2].Alignment = 2
  Coldetail.Columns[3].Text = "montant TTC"
  Coldetail.Columns[3].Alignment = 2
  Datej.text = Format$(Now, "dd.mm.yyyy")
  Datej.SetFocus

End

'**************************
'*  On récupère les BL    *
'**************************
Public Sub recup_bl()

  Dim Tab1 As String
  Dim Tab3 As String
  Dim Tab4 As String
  Dim Client As Result
  Dim Bl As Result
  Dim totf As Result
  Dim Total, totalttc As String
  Dim dteN2, DateAb, DateAb2, Aban, DteFac, codecli As String
  Dim impok As Boolean = False
  Dim nb As Integer = 0

  Tab = "Fiches_Bl"
  Tab1 = "Fiches_Ligbl"
  Tab3 = "Facturefm"
  Tab4 = "Bl"
  Total = "0"
  Utils.db.Exec("drop Table IF exists " & Tab3 & "")
  Utils.db.Exec("CREATE TABLE " & Tab3 &
    "(code Char(8) NOT NULL," &
    "nom Char(35)," &
    "cp Char(5)," &
    "ville Char(35)," &
    "totf Char(12)," &
    "tottc Char(12)," &
    "PRIMARY KEY (code))" & Utils.db.Engine())
  Utils.db.Exec("drop Table IF exists " & Tab4 & "")
  Utils.db.Exec("CREATE TABLE " & Tab4 &
    "(num Char(12) NOT NULL," &
    "code Char(10)," &
    "date date," &
    "ht Char(12)," &
    "ttc Char(12)," &
    "PRIMARY KEY (num))" & Utils.db.Engine())
  DteN2 = Format$(Now, "dd.mm.yyyy")
  If Radiobutton1.Value = True Then
    codeclient.Background = &HD4D0C8&
    Client = Utils.db.Exec("SELECT * FROM " & Tab & " Left join " & Cbase.Table("TabCli") & " on cli_code = cdclibl where type = &1 and totalht <> &2 and dtefac <= &3 or type = &1 and totalht <> &2 and isnull(dtefac) order by cdclibl asc, dtefac desc", "A", 0, Utils.cdate_dbase(dteN2))
  Else
    Client = Utils.db.Exec("SELECT * FROM " & Tab & " Left join " & Cbase.Table("TabCli") & " on cli_code = cdclibl  where cdclibl = &1 and type = &2 and totalht <> &3 and dtefac <= &4 or cdclibl = &1 and type = &2 and totalht <> &3 and isnull(dtefac) order by dtefac desc", codeclient.Text, "A", 0, Utils.cdate_dbase(dteN2))
  Endif
  If Client.Available Then
    Repeat
      dateAb = Client!cli_datab
      Aban = Client!cli_aban
      DteFac = Client!dtefac
      If IsNull(Aban) Then
        Message.Warning("Le client " & Client!cdclibl & " ne pas pas être traité! Veuillez complèter sa fiche SVP")
      Else
        If codecli <> client!cdclibl Then
          If Not IsNull(DteFac) Then
            Select Case Aban
              Case "1- Mensuel"
                dateAb2 = (Val(Mid$(Datej.Text, 4, 2)) - 1)
                If Val(DateAb2) <= 0 Then DateAb2 = Str(12 - Val(DateAb2))
                If Val(Left$(DteFac, 2)) = DateAb2 Then
                  If Val(dateAb) <= (Val(Left$(Datej.Text, 2))) Then impok = True
                Else
                  If Abs(Val(Left$(DteFac, 2)) - DateAb2) > 1 Then impok = True
                Endif
              Case "2- Bimensuel"
                dateAb2 = (Val(Mid$(Datej.Text, 4, 2)) - 2)
                If Val(DateAb2) <= 0 Then DateAb2 = Str(12 - Val(DateAb2))
                If Val(Left$(DteFac, 2)) = DateAb2 Then
                  If Val(dateAb) <= (Val(Left$(Datej.Text, 2))) Then impok = True
                Else
                  If Abs(Val(Left$(DteFac, 2)) - DateAb2) > 2 Then impok = True
                Endif
              Case "3- Trimestriel"
                dateAb2 = (Val(Mid$(Datej.Text, 4, 2)) - 3)
                If Val(DateAb2) <= 0 Then DateAb2 = Str(12 - Val(DateAb2))
                If Val(Left$(DteFac, 2)) = DateAb2 Then
                  If Val(dateAb) <= (Val(Left$(Datej.Text, 2))) Then impok = True
                Else
                  If Abs(Val(Left$(DteFac, 2)) - DateAb2) > 3 Then impok = True
                Endif
              Case "4- Semestriel"
                dateAb2 = (Val(Mid$(Datej.Text, 4, 2)) - 6)
                If Val(DateAb2) <= 0 Then DateAb2 = Str(12 - Val(DateAb2))
                If Val(Left$(DteFac, 2)) = DateAb2 Then
                  If Val(dateAb) <= (Val(Left$(Datej.Text, 2))) Then impok = True
                Else
                  If Abs(Val(Left$(DteFac, 2)) - DateAb2) > 6 Then impok = True
                Endif
              Case "5- Annuel"
                dateAb2 = (Val(Mid$(Datej.Text, 4, 2)) - 12)
                If Val(DateAb2) <= 0 Then DateAb2 = Str(12 - Abs(Val(DateAb2)))
                If Val(Left$(DteFac, 2)) = Val(Mid$(Datej.Text, 4, 2)) Then
                  If Val(Right$(DteFac, 4)) = (Val(Right$(Datej.Text, 4)) - 1) Then
                    If Val(dateAb) <= (Val(Left$(Datej.Text, 2))) Then impok = True
                  Else
                    If Abs(Val(Left$(DteFac, 2)) - DateAb2) > 12 Then impok = True
                  Endif
                Endif
            End Select
            If IsNull(dtefac) Then impok = True
          Else
            impok = True
            Inc nb
          Endif
          If impok = True Then
            totf = Utils.db.Exec("SELECT * FROM " & Tab3 & " WHERE code = &1", Client!cdclibl)
            If totf.Available Then
              Total = Format$(Val(totf!totf) + Val(Utils.cpoint(Client!totalht)), "0.00")
              Totalttc = Format$(Val(totf!tottc) + Val(Utils.cpoint(Client!totalttc)), "0.00")
              Utils.db.Exec("UPdate " & Tab3 & " SET totf = &1, tottc = &2 WHERE code = &3", Total, Totalttc, Client!cdclibl)
            Else
              Try Total = Format$(Client!totalht, "0.00")
              Try Totalttc = Format$(Client!totalttc, "0.00")
              Utils.db.Exec("INSERT INTO " & Tab3 & " (code, nom, cp, ville, totf, tottc) Values (&1, &2, &3,&4,&5, &6)", Client!cdclibl, Client!nmclibl, Client!cpbl, Client!villebl, Total, totalttc)
            Endif
            Total = 0
            Bl = Utils.db.Exec("SELECT * FROM " & Tab1 & " where num_ligbl = &1 order by num_ligbl", Client!numbl)
            If Bl.Available Then
              Utils.db.Exec("INSERT INTO " & Tab4 & " (num, code, date, ht, ttc) Values (&1, &2, &3, &4, &5)", Client!numbl, Client!cdclibl, Client!datebl, Client!totalht, Client!totalttc)
            Endif
            impok = False
          Endif
        Endif
        codecli = client!cdclibl
      Endif
    Until Client.MoveNext()
    Client = Utils.db.Exec("SELECT * FROM " & Tab3 & " order by nom")
    If Client.Available Then
      Repeat
        Colbl.Add(Client!code, Client!code)
        Colbl.Item[0] = Client!code
        Colbl.Item[1] = Client!nom
        Colbl.Item[2] = Client!cp
        Colbl.Item[3] = Client!ville
        Colbl.Item[4] = Client!totf
        Colbl.Item[5] = Client!tottc
      Until Client.MoveNext()
    Endif
  Endif

End

Public Sub Colbl_Click()

  Dim Client As Result

  Tab4 = "Bl"
  Coldetail.clear
  With Utils
    If Not Colbl.Available Then
      Colbl.clear
    Else
      Client = Utils.db.Exec("SELECT * FROM " & Tab4 & " where code = &1 order by num", Colbl.Item[0], "B", "F", 0)
      sclient = Colbl.Item[0]
      If Client.Available Then
        Repeat
          Coldetail.Add(Client!num, Client!num)
          Coldetail.Item[0] = Client!num
          Coldetail.Item[1] = .Cdate_Aff(Client!date)
          Coldetail.Item[2] = Format$(Val(.cpoint(Client!ht)), "0.00")
          Coldetail.Item[3] = Format$(Val(.cpoint(Client!ttc)), "0.00")
        Until Client.MoveNext()
      Endif
    Endif
  End With

End

Public Sub Colbl_Keypress()

  Dim Client As Result

  Tab3 = "Facturefm"
  Tab4 = "Bl"
  If Key.code = Key.Delete And Colbl.Count <> 0 Then
    Utils.db.Exec("delete from " & Tab3 & " WHERE code = &1 ", sclient)
    Utils.db.Exec("delete from " & Tab4 & " WHERE code = &1 ", sclient)
  Endif
  Colbl.Clear
  Coldetail.Clear
  Client = Utils.db.Exec("SELECT * FROM " & Tab3 & " order by nom")
  If Client.Available Then
    Repeat
      Colbl.Add(Client!code, Client!code)
      Colbl.Item[0] = Client!code
      Colbl.Item[1] = Client!nom
      Colbl.Item[2] = Client!cp
      Colbl.Item[3] = Client!ville
      Colbl.Item[4] = Client!totf
      Colbl.Item[5] = Client!tottc
    Until Client.MoveNext()
  Endif

End

Public Sub Coldetail_Click()

  sclient2 = Coldetail.Item[0]

End

Public Sub Coldetail_Keypress()

  Dim Client As Result
  Dim Total As String = "0"

  Tab3 = "Facturefm"
  Tab4 = "Bl"
  With Utils
    If Key.code = Key.Delete And Coldetail.Count <> 0 Then
      Utils.db.Exec("delete from " & Tab4 & " WHERE num = &1 ", sclient2)
    Endif
    Client = Utils.db.Exec("SELECT * FROM " & Tab4 & " where code = &1 order by num", sclient)
    Coldetail.Clear
    If Client.Available Then
      Repeat
        Coldetail.Add(Client!num, Client!num)
        Coldetail.Item[0] = Client!num
        Coldetail.Item[1] = .Cdate_Aff(Client!date)
        Coldetail.Item[2] = Client!ht
        Colbl.Item[3] = Client!ttc
        Total = Format$(Val(.cpoint(Total)) + Val(.cpoint(Client!ht)), "0.00")
      Until Client.MoveNext()
    Endif
    Colbl.MoveFirst()
    Repeat
      Colbl.Item.Selected = True
      If Colbl.Item[0] = sclient Then
        Colbl.Item[4] = Total
        Break
      Endif
    Until Colbl.MoveNext()

  End With

End

'**********************************************************
'*  On controle si la date saisie est dans les bornes     *
'**********************************************************
Public Sub Quittedate()

  Dim dte2 As String
  Dim dte3 As String
  Dim ye As String

  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  dtex = rResult!dteclec ' On recupere la date de fin d'exercice
  dte = rResult!dtepc
  dte = Utils.Cdate_aff(dte)
  dte3 = Right$(dte, 4) & Left$(dte, 2)
  dte2 = rResult!dteclec1
  dte2 = Utils.Cdate_aff(dte2)
  ye = Right$(dte2, 4)
  Ye = Val(Ye) + 1
  With utils
    datej.text = .Cdate_calc(datej.text)
    datej.Text = .Cdate_aff(datej.Text)
    b = 0
    If datej.Text = "00.00.0:00" Then
      datej.Text = Format$(Now, "dd.mm.yyyy")
      b = 1
      datej.SetFocus
    Else
      dte3 = rResult!dtepec
      dte3 = Right$(dte3, 4) & Left$(dte3, 2)
      If Right$(datej.text, 4) & Mid$(datej.text, 4, 2) < dte3 Then
        If son Then
          Music.Play
        Endif
        If Message.Warning("Attention ! La date saisie est inférieure au début de la période en cours.", "Ok") = 1 Then
          datej.SetFocus
          B = 1
        Endif
      Else
        If Right$(datej.text, 4) & Mid$(datej.text, 4, 2) > dte3 Then
          If son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! La date saisie est supérieure à la période en cours.", "Ok") = 1 Then
            datej.SetFocus
            B = 1
          Endif
        Else
        Endif
      Endif
    Endif
    Try numecr = "numecriture"
  End With

End

Public Sub Button1_KeyPress()

  Button1_Click()

End

Public Sub Button1_Click()

  Colbl.Clear
  Coldetail.Clear
  Quittedate()
  If B <> 1 Then
    recup_bl()
  Else
    b = 0
  Endif

End

Public Sub Button5_Click()

  If Exist(filename) Then Try Kill filename
'  Try Start.LocalSettings["/Soc" & Start.Societe & "/EnvoiFtp"] = ComboBox1.text
  Me.close

End

Public Sub Radiobutton1_Click()

  codeclient.Background = &HD4D0C8&
  codeclient.ReadOnly = True
  Colbl.clear
  Coldetail.clear

End

Public Sub Radiobutton2_Click()

  Dim Frmt As New String[]

  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Znss"])
  If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then codeclient.Background = Val(Frmt[0])
  codeclient.ReadOnly = False
  Colbl.clear
  Coldetail.clear
  codeclient.SetFocus

End

Public Sub codeclient_KeyPress()

  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", codeclient.Text)
    If rResult.Available Then
      Button1.SetFocus()
    Else
      Message.Error("Ce client n'existe pas !")
      codeclient.Select
      codeclient.SetFocus
    Endif
  Endif

End

Public Sub Togglebutton1_Click()

  Dim MyForm As Triclients

  If Radiobutton2.Value = False Then Radiobutton2.Value = True
  bsel = False
  MyForm = New Triclients("FacturefmA")
  MyForm.Showmodal()
  If Bsel = True Then
    codeclient.Text = Cclient
  Else
    Codeclient.SetFocus
  Endif

End

Public Sub combobox1_Change()

  If Left$(ComboBox1.text, 1) = "4" Then
    Button14.Text = "Imprimer"
  Else
    Button14.text = "Envoyer"
  Endif

End

Public Sub dtef_LostFocus()

  dtef.text = Utils.Cdate_calc(dtef.text)
  dtef.Text = Utils.Cdate_aff(dtef.Text)
  If dtef.Text = "00.00.0:00" Or If dtef.Text = ".." Then
    dtef.Text = Format$(Now, "dd.mm.yyyy")
    dtef.SetFocus
  Endif

End

Public Sub EnvoiFTP($code As String)

  Dim Cmdmk As New String[]
  Dim Chemin As String

  $code = hexdblKey.crypt("en", Right$($code, Len($code) - 3), $code)
  chemin = "/" & $code
  scode = Chemin
  Ftpclient1.URL = Start.LocalSettings["/Soc" & Start.Societe & "/Adrbase3"] & chemin & "/" & ty
  FTPClient1.Put(Copie.spiece)
  If Ftpclient1.Status <> 0 Then
    Ftpclient1.URL = Start.LocalSettings["/Soc" & Start.Societe & "/Adrbase3"] & chemin
    Cmdmk = ["MKD " & $code]
    Ftpclient1.Exec(Cmdmk)
    Ftpclient1.URL = Start.LocalSettings["/Soc" & Start.Societe & "/Adrbase3"] & chemin & "/" & ty
    FTPClient1.Put(Copie.spiece)
  Endif
  If Ftpclient1.Status = 0 Then
    Print #Hnew, $code & String$(18 - Len($code), " ") & Colbl.Item[0] & String$(10 - Len(Colbl.Item[0]), " ") & $rs_soc & " " & $cli_nom & " " & $cli_pnm & String$(52 - Len($rs_soc & " " & $cli_nom & " " & $cli_pnm), " ") & " " & numerofac & String$(24 - Len(numerofac), " ") & mttc & String$(14 - Len(mttc), " ") & mail2
  Else
    Message.warning("Il y a un problème d'envoi sur le serveur FTP pour le client " & $code & " !")
    Print #Hnew, "******************************************************************************************************************************"
    Print #Hnew, "Attention ! Problème d'envoi sur serveur FTP pour le client " & Colbl.Item[0] & " facture numéro " & numerofac
    Print #Hnew, "******************************************************************************************************************************"
  Endif

End

Public Sub Ftpclient1_read()

End

Public Sub FtpClient1_Error()

End

Public Sub FtpClient1_Connect()

End

Public Sub FtpClient1_Finished()

End

Public Sub Datej_KeyPress()

  If Key.code = Key.Escape Then
    If DateChooser1.Visible = True Then DateChooser1.Visible = False
  Endif
  If Key.code = Key.F2 Then
    If DateChooser1.Visible = True Then
      DateChooser1.Visible = False
    Else
      DateChooser1.Visible = True
    Endif
  Endif

End

Public Sub DateChooser1_Activate()

  Datej.text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  DateChooser1.Visible = False

End

'**********************************************
'*     Affichage de la documentation Html     *
'**********************************************
Public Sub Button7_Click()

  Doc.Open("Cabonnement")

End

' Gambas class file

Org As String = "1"
Type As String
Coulfc As Integer
Coulfond As New String[]
son As Integer = Start.Son
Public Bsel As Boolean = False
Public Bval As String
Private Tri As String
Private filename As String

Public Sub _new()

  Dim rResult As Result
  Dim Frmt As New String[]

  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Focus"])
  Coulfc = Val(Frmt[0])
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Fnets"])
  Coulfond = Utils.Coulfd()
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
  Dte1.Text = Utils.Cdate_Aff(rResult!dteclec5)
  type = "F"
  Me.Center

End

Public Sub Liste_Click()

  Dim Tab As String
  Dim rResult As Result

  Tab = "Artsup"
  Frame7.visible = False
  ListArt.Visible = True
  Panel1.Visible = False
  Panel2.Visible = False
  Panel3.Visible = False
  Panel4.Visible = True
  Art.SetFocus
  Try rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  If Not Error Then
    If rResult.Available Then
      If message.Question("Une liste existe déjà ! Que voulez-vous faire ?\n", " 1- La supprimer", " 2- Ajouter des articles") = 2 Then
        Repeat
          ListArt.Text = ListArt.Text & " " & rResult!art_code & " : " & rResult!art_design & "\n"
        Until rResult.MoveNext()
        Return
      Endif
    Endif
  Endif

  ListArt.Text = ""
  Utils.db.Exec("drop Table IF exists " & Tab & "")
  Utils.db.Exec("CREATE TABLE " & Tab &
    "(art_code Char(15) NOT NULL," &
    "art_design Char(50)," &
    "PRIMARY KEY (art_code))" & Utils.db.Engine())

End

Public Sub Fichier_Click()

  Frame7.visible = True
  ListArt.Visible = False
  Panel4.Visible = False

End

Public Sub CheckSpd_Click()

  Frame7.visible = False
  ListArt.Visible = False
  Panel1.Visible = False
  Panel2.Visible = False
  Panel3.Visible = False
  Panel4.Visible = False

End

Public Sub Selection_Click()

  Frame7.visible = False
  ListArt.Visible = False
  Panel1.Visible = True
  Panel2.Visible = True
  Panel3.Visible = True
  Panel4.Visible = False

End

Public Sub Choisir_Click()

  Dialog.Path = User.home
  Dialog.Title = "Choix du fichier texte"
  If Dialog.OpenFile() Then Return
  Fic.Text = Dialog.Path
Catch
  Message.Warning(ERROR.Text)

End

'*************************************** Gestion des champs de saisie **************************************************

Public Sub Suppr_KeyPress()

  If key.code = key.F2 Then
    Select Case Last.tag
      Case 3
        Button3_click()
        Stop Event

      Case 4
        Button4_click()
        Stop Event

      Case 7
        Button10_Click()

        Stop Event
    End Select
  Endif
  If Key.code = Key.enter Or Key.code = Key.return Then
    Select Case Last.tag

      Case 7
        art_man()
    End Select
  Endif

End

'*************************************** Gestion du choix de la date ****************************************************

Public Sub Button5_Click()

  If DateChooser1.Visible = False Then
    DateChooser1.visible = True
  Else
    DateChooser1.Visible = False
  Endif

End

Public Sub DateChooser1_Activate()

  Dte1.text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  DateChooser1.Visible = False

End

'******************************************* Gestion du choix des fournisseurs *********************************************

'***************************************
'* On selectionne le début de la liste *
'***************************************
Public Sub Button3_Click()

  Dim MyForm As TriCpt

  MyForm = New TriCpt(Type, TriCpt.Sans_Solde, Me)
  MyForm.Showmodal()
  If Bsel = True Then
    Cp1.text = Bval
    Cp2.SetFocus
  Endif

End

'***************************************
'* On selectionne la fin de la liste   *
'***************************************
Public Sub Button4_Click()

  Dim MyForm As TriCpt

  MyForm = New TriCpt(Type, TriCpt.Sans_Solde, Me)
  MyForm.Showmodal()
  If Bsel = True Then
    Cp2.text = Bval
    Cp1.SetFocus
  Endif

End

'*********************************************** On gère l'affichage des familles *************************************

'************************************
'* Affichage du columnview Colfam  *
'************************************
Public Sub Button1_Click()

  Org = "1"
  Aff()

End

Public Sub Button2_Click()

  Org = "2"
  Aff()

End

Public Sub Aff()

  Dim Rfams As Result

  With Utils
    If Colfam.visible Then
      Colfam.clear
      Colfam.visible = False
    Else
      Colfam.visible = True
      Colfam.Columns.count = 2
      Colfam.Columns[0].Width = 65
      Colfam.Columns[1].Width = 280
      Colfam.Columns[0].Text = "code"
      Colfam.Columns[1].Text = "Intitulé"
      Rfams = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFam") & " order by code_fam")
      If Rfams.Available Then
        Repeat
          Colfam.Add(Rfams!code_fam, Rfams!code_fam)
          Colfam.Item[0] = Rfams!code_fam
          Colfam.Item[1] = Rfams!libell_fam
        Until Rfams.MoveNext()
      Endif
      If Colfam.Count Then
        Colfam.MoveFirst
        Colfam.SetFocus
        Colfam.Item.Selected = True
      Endif
    Endif
  End With

End

'***********************************************************
'* Gestion du columnview Colfam lors d'une saisie manuelle *
'***********************************************************
Public Sub Colfam_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colfam.MoveCurrent
    Colfam_Click()
  Endif

  If key.code = key.F1 Then
    Button1_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colfam.visible = False
    Colfam.clear
    fam1.SetFocus
    fam1.Select
    Stop Event
  Endif

End

'*************************************
'*      Selection de la famille      *
'*************************************
Public Sub Colfam_Click()

  If org = "1" Then
    Fam1.Text = Colfam.Item[0]
  Else
    Fam2.Text = Colfam.Item[0]
  Endif
  Colfam.clear
  Colfam.visible = False
  fam2.Select
  fam2.SetFocus

End

'****************************************Gestion des articles**************************************************
Public Sub SelectionArt()

  Dim MyForm As TriArticles

  MyForm = New TriArticles(True, False, "art_code", "", "", Null, False, False, Me)
  MyForm.Showmodal()
  If Bsel = True Then
    Art.text = Bval
    art_man()
  Endif

End

Public Sub ChkPrx()

  If InStr("0123456789,.", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif

End

'***************************************************
'* Saisie d'un code article manuellement en direct *
'***************************************************
Public Sub art_man()

  Dim rarts As Result
  Dim Tab As String

  Tab = "Artsup"
  With utils
    If Art.text <> "" Then
      rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Art.Text)
      If Not rarts.Available Then
        rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_cfour = &1", Art.Text)
        If Not rarts.Available Then
          rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_cbarre = &1", Art.Text)
        Endif
      Endif
      If rarts.Available Then
        Art.Text = rarts!art_code
        Try Utils.db.Exec("INSERT INTO " & Tab & " (art_code, art_design) Values (&1,&2)", rarts!art_code, Left(rarts!art_design, 50))
        If Not Error Then
          ListArt.Text = ListArt.Text & " " & rarts!art_code & " : " & rarts!art_design & "\n"
        Else
          message.Error("Ce produit a déjà été saisi !")
        Endif
        Art.Clear
        Design.Text = ""
        Art.SetFocus
      Else
        If son Then
          Music.Play
        Endif
        message.Warning(" Cette référence n'existe pas! ")
        Art.SetFocus
        Art.Select
      Endif
    Endif
  End With

End

Public Sub button8_Click()

  Dim aResult As Result
  Dim hResult As Result
  Dim cmResult As Result
  Dim Tab As String
  Dim i As Integer = 0
  Dim s As Integer = 0
  Dim Sp As Boolean = False
  Dim hfil As File
  Dim filename As String
  Dim Errtxt As String
  Dim PB As ProgBar

  Tab = "Artsup"
  filename = User.Home & "/tmp/Artsuppr.txt"
  Hfil = Open filename For Write Create
  If Message.Question("Attention ! Seuls les produits séléctionnés ayant un stock égal à zéro (ou non stocké) et non utilisés (documents en cours) seront supprimés.", "Supprimer", "Sortir") = 1 Then
    Me.mouse = Mouse.wait
    If Not fichier.value Then
      If CheckSpd.value = True Then aResult = Utils.db.Exec("SELECT art_code, art_design FROM " & Cbase.Table("TabArt") & " where art_suspendu = &1 and art_fam > &2 and art_fam < &3 and art_four > &4 and art_four < &5", True, Fam1.text, Fam2.Text, Cp1.text, Cp2.Text)
      If Liste.Value = True Then aResult = Utils.db.Exec("SELECT * from " & Tab & "")
      If Liste.value = False And CheckSpd.value = False Then aResult = Utils.db.Exec("SELECT art_code, art_design FROM " & Cbase.Table("TabArt") & " where art_fam > &1 and art_fam < &2 and art_four > &3 and art_four < &4", Fam1.text, Fam2.Text, Cp1.text, Cp2.Text)
      If aResult.Available Then
        PB = New ProgBar("Suppression Articles", aResult.Count, Null, True, "", True)
        PB.Show()
        Repeat
          If PB.Avancement(aResult!art_design, 5) Then Break
          hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabHisLigFac") & " where dtligbl_ligfac >= &1 and code_ligfac = &2 union SELECT * FROM " & Cbase.Table("TabHisLigFacm") & " where dtligbl_ligfac >= &1 and code_ligfac = &2", LDate(dte1.Text).D, aResult!art_code)
          If ((Not hResult.Available And Selection.Value) Or Not Selection.Value) Then
            Errtxt = Articles.art_Suppr(aResult!art_code, False)
            If Errtxt <> "" Then
              Inc s
              Print #Hfil, Errtxt
            Else
              Inc i
            Endif
          Else
            Inc s
            Print #Hfil, Errtxt
            Errtxt = "Suppression " & aResult!art_code & " impossible! car present en archive facture apres la date " & LDate(dte1.Text).L & "."
          Endif
        Until aResult.MoveNext()
        PB.Close()
      Endif
      Close #hfil
      If i = 0 Then message.info("Traitement terminé ! aucun article supprimé.")
      If i >= 1 Then message.info("Traitement terminé ! " & i & " article(s) supprimé(s).")
      If s >= 1 Then
        message.info("Attention ! impossible de supprimer " & s & " article(s).")
        Editeur.Prog_Editeur(Filename)
      Endif
    Else
      Suppression()
    Endif
  Endif
  Me.mouse = mouse.Default

End
'***********************************************
'*     Suppression a partir d'un fichier       *
'***********************************************

Public Sub Suppression()

  Dim hfil, hfile As File
  Dim lig As String
  Dim i, s As Integer = 0
  Dim Errtxt As String

  filename = User.Home & "/tmp/Artsuppr.txt"
  hFil = Open filename For Write Create
  hFile = Open fic.Text For Read
  Me.Mouse = Mouse.Wait
  While Not Eof(hFile)
    Line Input #hFile, Lig
    Errtxt = Articles.art_Suppr(Lig, False)
    If Errtxt <> "" Then
      Inc s
      Print #Hfil, Errtxt
    Else
      Inc i
    Endif
  Wend
  Close #hfil
  Close #hfile
  If i = 0 Then message.info("Traitement terminé ! aucun article supprimé.")
  If i >= 1 Then message.info("Traitement terminé ! " & i & " article(s) supprimé(s).")
  If s >= 1 Then
    message.info("Attention ! impossible de supprimer " & s & " article(s).")
    Editeur.Prog_Editeur(Filename)
  Endif

End

Public Sub button9_Click()

  If Exist(filename) Then Try Kill filename
  Me.close

End

Public Sub Button10_Click()

  SelectionArt()

End

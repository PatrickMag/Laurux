' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : ClotureF.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 07/11/2007
'# Cloture mensuelle de la facturation
'################################################
'

Tab As String
Dtpc As String
Dtepp As String ' date période précédente en facturation
Entbonl As Result
Remmo As String
Remart As String
TotSldHP As Float
TotDeb As Float
TotCred As Float
TotSld As Float
debit As Float
credit As Float
Compt As String
Private Nfac As String
Private borientation As Boolean
Private $soption As String

Public Sub _New()

  Music.Load(Start.Musique)
  Me.Center
  Utils.Observers(Me)
  $soption = Utils.Option()
  
End

Public Sub Form_Open()

  Aff_date()

End

Public Sub Aff_date()

  Dim rResult As Result

  Tab = "Fiches_Parametres"
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
    If Not rResult.Available Then
      Message.Warning("Veuillez completez la table des parametres généraux SVP avant de faire vos clotures", "OK")
      Start.UnLock()
      Utils.fermeTunnel()
      Utils.db.Close
      Quit
    Else
      If rResult!dtepec = "" Or If Left$(rResult!dtepec, 2) = "00" Then
        Dtpc = Format$(Now, "mm.yyyy")
      Else
        Dtpc = rResult!dtepec
      Endif
      If rResult!dtepp = "" Or If Left$(rResult!dtepp, 2) = "00" Then
        Dtepp = Format$(Now, "mm.yyyy")
      Else
        Dtepp = rResult!dtepp
      Endif
      Dtpc = "01." & Dtpc
      Dtepp = "01." & Dtepp
      dateprc.Text = "  " & Format$(Date(Right(dtepp, 4), Mid(dtepp, 4, 2), "01"), "mmmm  yyyy")
      datecl.Text = "  " & Format$(Date(Right(dtpc, 4), Mid(dtpc, 4, 2), "01"), "mmmm  yyyy")
    Endif
  End With

End

Public Sub Button3_Click()

  Me.Close

End

Public Sub Button1_Click()

  Dim Tab2 As String

  Tab = "Fiches_Bl"
  Tab2 = "Fiches_Parametres"
  With Utils
    If Message.Question("Etes vous sur de vouloir lancer la cloture du mois de" & datecl.Text, "Oui", "Non") = 1 Then
      Maj_Archives()
    Endif
  End With
  Try Me.Close

End

'**********************************************************
'*                   Maj Entetes Archives                 *
'**********************************************************
Public Sub Maj_Archives()

  Dim Parmt As Result
  Dim Entbon As String
  Dim Parm As String
  Dim Dppc As String
  Dim PB As ProgBar
  Dim opt As ObjFacB
  
  Entbon = "Fiches_Bl"
  Parm = "Fiches_Parametres"
  With Utils
    Entbonl = Utils.db.Exec("SELECT * FROM " & Entbon & " where imp = &1 and type = &2 and dtefac <= &3 UNION ALL SELECT * FROM " & Entbon & "M where imp = &1 and type = &2  and dtefac < &3 ", 1, "F", Right(dtpc, 4) & Mid(dtpc, 4, 2) & 31)
    If EntBonl.Available Then
      PB = New ProgBar("Cloture mensuelle de facturation", EntBonl.Count)
      PB.Show()
      PB.Avancement("Facture " & Entbonl!numfac, 1)
      Repeat
        If Right(.Cdate_Aff(Entbonl!dtefac), 4) & Mid(.Cdate_Aff(Entbonl!dtefac), 4, 2) Then
'          ObjFacB(Entbonl!numbl, ObjFac.facture).transblfac
          opt = New ObjFacB(Entbonl!numbl, ObjFac.facture)
          opt.numcli = Entbonl!cdclibl
          opt.calcul
          opt.transblfac()
        Endif
        If PB.Avancement("Facture " & Entbonl!numfac, 25) = True Then Break
      Until Entbonl.MoveNext()
      PB.Close()
    Endif

    Dtepp = Dtpc
    ' On incrémente la période en cours
    Dppc = Mid(dtpc, 4, 2)
    Dppc = Val(Dppc) + 1
    Dppc = Format$(Dppc, "00")
    If Val(dppc) > 12 Then
      dppc = "01"
      dtpc = dppc & "." & Str(Val(Right$(dtpc, 4)) + 1)
    Else
      dtpc = Dppc & "." & Right$(dtpc, 4)
    Endif
    ' Met à jour la table des parametres
    Parmt = Utils.db.Exec("SELECT * FROM " & Parm & "")
    Utils.db.Exec("UPdate  " & Parm & "  SET  dtepp  =  &1, dtepec  =  &2", Right(dtepp, 7), Right(dtpc, 7))
  End With

  Calc_solde()

End

'*****************************
'*   On calcule  les soldes  *
'*****************************
Public Sub Calc_solde()

  Dim i As Integer
  Dim rResult As Result
  Dim rrResult As Result
  Dim Tab2 As String
  Dim Intit As String
  Dim p1 As Integer
  Dim PB As ProgBar

  totsldhp = 0.00
  Tab = "Fiches_Mvt"
  Tab2 = "Fiches_Comptes"
  p1 = 1
  With Utils
    rrResult = Utils.db.Exec("SELECT compte_cc, intitule_cc  FROM " & Tab2 & " order by cast(compte_cc AS char)")
    If rrResult.Available Then
      PB = New ProgBar("Calcul des soldes", rrResult.Count)
      PB.Show()
      Repeat
        compt = rrResult!compte_cc
        Intit = rrResult!intitule_cc
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1  and validee = &2  order by dte ", compt, 1)
        If rResult.count <> 0 Then
          i = 0
          While i < rResult.count
            debit = rResult!montantd
            credit = rResult!montantc
            totdeb = totdeb + debit
            totcred = totcred + credit
            totsld = totdeb - totcred
            Inc i
            rResult.MoveNext()
          Wend
          Utils.db.Exec("UPdate " & Tab2 & "  SET solde = &2 where compte_cc = &1", Compt, .PointBase(Totsld))
        Else
          totsld = 0
          Utils.db.Exec("UPdate " & Tab2 & "  SET solde = &2 where compte_cc = &1", Compt, .PointBase(Totsld))
        Endif
        totdeb = 0
        totcred = 0
        totsld = 0
        If PB.Avancement("Compte " & compt, 200) = True Then Break
      Until rrResult.MoveNext()
      PB.Close()
    Endif
  End With
  If Start.son Then
    Music.Play
  Endif
  Me.Mouse = Mouse.Default
  message.Info(" Traitement terminé", "OK")
  Me.Close

End

Public Sub Button2_Click()
  'Doc.Open("ClotureF")

End
